generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "cockroachdb"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id            Int            @id @default(sequence())
  handle        String         @unique
  email         String         @unique
  bio           String?
  trustScore    Int            @default(0)
  verifiedFlags Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  password      String
  followers     Follow[]       @relation("UserFollowers")
  following     Follow[]       @relation("UserFollowing")
  notifications Notification[]
  posts         Post[]
  reactions     Reaction[]
  reports       Report[]
  refreshTokens RefreshToken[]

  @@map("users")
}

model Post {
  id          Int          @id @default(sequence())
  userId      Int
  text        String
  media       Json?
  createdAt   DateTime     @default(now())
  replyTo     Int?
  quotePostId Int?
  isHidden    Boolean      @default(false)
  symbols     PostSymbol[]
  quotePost   Post?        @relation("PostQuotes", fields: [quotePostId], references: [id])
  quotes      Post[]       @relation("PostQuotes")
  replyToPost Post?        @relation("PostReplies", fields: [replyTo], references: [id])
  replies     Post[]       @relation("PostReplies")
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactions   Reaction[]
  reports     Report[]

  @@index([userId])
  @@index([replyTo])
  @@index([quotePostId])
  @@index([createdAt])
  @@map("posts")
}

model Symbol {
  id       Int          @id @default(sequence())
  ticker   String
  exchange String
  kind     SymbolKind
  meta     Json?
  posts    PostSymbol[]

  @@unique([ticker, exchange])
  @@index([kind])
  @@map("symbols")
}

model PostSymbol {
  postId   Int
  symbolId Int
  post     Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  symbol   Symbol @relation(fields: [symbolId], references: [id], onDelete: Cascade)

  @@id([postId, symbolId])
  @@map("post_symbols")
}

model Follow {
  followerId Int
  followeeId Int
  followee   User @relation("UserFollowers", fields: [followeeId], references: [id], onDelete: Cascade)
  follower   User @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)

  @@id([followerId, followeeId])
  @@index([followerId])
  @@index([followeeId])
  @@map("follows")
}

model Reaction {
  id     Int          @id @default(sequence())
  postId Int
  userId Int
  type   ReactionType
  post   Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, type])
  @@index([postId])
  @@index([userId])
  @@map("reactions")
}

model Notification {
  id        Int              @id @default(sequence())
  userId    Int
  kind      NotificationKind
  payload   Json
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([readAt])
  @@index([createdAt])
  @@map("notifications")
}

model Report {
  id         Int          @id @default(sequence())
  postId     Int
  reporterId Int
  reason     ReportReason
  details    String?
  createdAt  DateTime     @default(now())
  post       Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter   User         @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([reporterId])
  @@index([reason])
  @@index([createdAt])
  @@map("reports")
}

model RefreshToken {
  id        Int      @id @default(sequence())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

enum SymbolKind {
  STOCK
  CRYPTO
  ETF
}

enum ReactionType {
  LIKE
  BOOKMARK
  BOOST
}

enum NotificationKind {
  MENTION
  REPLY
  REACTION
  FOLLOW
}

enum ReportReason {
  SPAM
  SCAM
  HARASSMENT
  ILLEGAL
  OTHER
}
